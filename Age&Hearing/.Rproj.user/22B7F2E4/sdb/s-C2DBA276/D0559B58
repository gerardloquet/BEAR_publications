{
    "collab_server" : "",
    "contents" : "##\n\nlibrary(reshape2)\nlibrary(corrgram)\nlibrary(party)\nlibrary(ggmosaic)\nlibrary(gridExtra)\nlibrary(plotly)\n\n\nif(!require(\"tidyverse\")){\n  install.packages(\"tidyverse\")\n  library(tidyverse)\n}\ndatafolder <- \"../../../Data/data/MsC\"\nfiles <- c(\"15D-baseline.csv\",\n           \"15D-followUP.csv\",\n           \"Audiogram_left_classified.csv\",\n           \"Audiogram_right_classified.csv\",\n           \"Demographics.csv\",\n           \"Fitting_rationale.csv\",\n           \"HA_experience_use-time.csv\",\n           \"SSQ12_IOI-HA_baseline.csv\",\n           \"SSQ12_IOI-HA_visit_2.csv\",\n           \"Low-benefit3rd.csv\",\n           \"Motivation.csv\",\n           \"Person-characteristics.csv\",\n           \"QoL-baseline+follow-up.csv\",\n           \"SSQ-baseline.csv\",\n           \"SSQ-follow-up.csv\",\n           \"SSQ_age_gender.csv\",\n           \"THI-baseline.csv\",\n           \"THI-follow-up.csv\",\n           \"Tid-mellem.csv\",\n           \"Tinnitus.csv\")\n\n#names(files) <- c(\"15d-1\",\"15d-2\",\"audiogram-l\",\"audiogram-r\",\"demo\",\"fitting\",\"ha-exp\",\"ssq+ioi-1\",\"ssq+ioi-2\",\"low-benefit\",\"motivation\",\"person-stats\",\"qol-1+2\",\"\")\n\nfa_sex <- c(\"Male\", \"Female\")\nfa_fin <- c(\"Incomplete\", \"Unverified\", \"Complete\")\nfa_brands <- c(\"Oticon\",\"GN ReSound\",\"Widex\",\"Bernafon\", \"Rexton\", \"Siemens/Sivantos\", \"Phonak\",\"Unitron\",\"Danacom\",\"Other\")\n\n\n#15d\ndf_15d <- rbind(read.csv(paste(datafolder,\"15D-baseline.csv\",sep=\"/\")),\n                read.csv(paste(datafolder,\"15D-followup.csv\",sep=\"/\")))\ndf_15d$d_complete <- factor(df_15d$d_complete, levels = 0:2, labels = fa_fin)\ndf_15d[,3:17] <- lapply(df_15d[,3:17], factor, \n                             levels=c(1,2,3,4,5), \n                             ordered = TRUE)\n\ndf_15d_base <- filter(df_15d, redcap_event_name == \"baseline_arm_1\")\ndf_15d_follow <- filter(df_15d, redcap_event_name == \"besoeg2_arm_1\")\n\n#motivation\ndf_motivation <- read.csv(paste(datafolder,\"Motivation.csv\",sep=\"/\"), colClasses = c(rep('factor', 3),rep('integer', 3),'factor'))#2/19\ndf_motivation$sex <- factor(df_motivation$sex, levels = 1:2, labels=fa_sex)\ndf_motivation$own_ha <- factor(df_motivation$own_ha, levels=0:1, labels=c(\"No\", \"Yes\"))\n\n\n#audiogram\ndf_audiogram_left <- read.csv(paste(datafolder, \"Audiogram_left_classified.csv\", sep = \"/\")) #14/19\ndf_audiogram_left$Gender <- factor(df_audiogram_left$Gender, levels = c(1,0), labels = fa_sex)\ncolnames(df_audiogram_left)[colnames(df_audiogram_left)==\"ID\"] <- \"record_id\"\ndf_audiogram_left$X <- NULL\ndf_audiogram_left$Side <- \"left\"\n\ndf_audiogram_right <- read.csv(paste(datafolder, \"Audiogram_right_classified.csv\", sep = \"/\")) #15/19\ncolnames(df_audiogram_right)[colnames(df_audiogram_right)==\"AGE\"] <- \"Age\"\ndf_audiogram_right$Gender <- factor(df_audiogram_right$Gender, levels = c(1,0), labels = fa_sex)\ncolnames(df_audiogram_right)[colnames(df_audiogram_right)==\"ID\"] <- \"record_id\"\ndf_audiogram_right$X <- NULL\ndf_audiogram_right$Side <- \"right\"\n\ndf_audiogram <- rbind(df_audiogram_left, df_audiogram_right)\ndf_audiogram$Side <- factor(df_audiogram$Side)\n\n#redundant data?\n#df_person_characteristics <- read.csv(paste(datafolder,files[11],sep=\"/\"))#18/19 #identisk med df_motivation\n#df_demographics <- read.csv(paste(datafolder,files[5],sep=\"/\"))#19/19\n\n#fitting rationale\ndf_fitting_rationale <- read.csv(paste(datafolder, \"Fitting_rationale.csv\", sep = \"/\")) #12/19\n#Noget stemmer ikke overnes med hensyn til manufaktør, (måske?)\ndf_fitting_rationale$fittingrationale <- \n  factor(df_fitting_rationale$fittingrationale,\n         levels = c(1:6),\n         labels = c(\"Firmarationale\",\n                    \"NAL-NL2\",\n                    \"NAL-NL1\",\n                    \"DSL v.5 til voksen\",\n                    \"DSL v.5 til børn\",\n                    \"Andet\"))\ndf_fitting_rationale$ha_manufactor <- \n  factor(df_fitting_rationale$ha_manufactor, \n         levels = c(1:10), \n         labels = fa_brands)\ndf_fitting_rationale$ha_model2 <-\n  factor(df_fitting_rationale$ha_model2,\n         levels = c(1:10),\n         labels = c(\"D220\",\"D330\",\"D440\",\"C220\",\"C330\",\"C440\",\"M220\",\"M330\",\"M440\",\"Other\"))\ndf_fitting_rationale$ha_model3 <-\n  factor(df_fitting_rationale$ha_model3,\n         levels = c(1:7),\n         labels = c(\"Agil\",\"Alta\",\"Alta Pro\",\"Alta Pro2\",\"Chili\",\"Sensei Pro\",\"Other\"))\ndf_fitting_rationale$ha_model4 <-\n  factor(df_fitting_rationale$ha_model4,\n         levels = c(1:4))#, labels = ?)\ndf_fitting_rationale$ha_model5 <-\n  factor(df_fitting_rationale$ha_model5,\n         levels = c(1:7))#, labels = ?)\ndf_fitting_rationale$ha_model6 <-\n  factor(df_fitting_rationale$ha_model6)\n#levels = c(1:7), labels = ?)\ndf_fitting_rationale$ha_model7 <-\n  factor(df_fitting_rationale$ha_model7,\n         levels = c(1:10))#, labels = ?)\ndf_fitting_rationale$ha_type <- \n  factor(df_fitting_rationale$ha_type, \n         levels = c(1:6), \n         labels = c(\"CIC\",\"ITC/ITE\",\"BTE (RITE)\",\"BTE (tyndslange)\",\"BTE (m. øreprop)\",\"BTE (power)\"))\ndf_fitting_rationale$ha_type_mm_complete <-\n  factor(df_fitting_rationale$ha_type_mm_complete,\n         levels = c(1:3),\n         labels = fa_fin)\n\n#ha experince use time\ndf_ha_use <- read.csv(paste(datafolder, \"HA_experience_use-time.csv\", sep = \"/\" )) #13/19\ndf_ha_use$sex <- \n  factor(df_ha_use$sex, \n         levels=c(1,2),\n         labels = fa_sex)\ndf_ha_use$own_ha <- \n  factor(df_ha_use$own_ha, \n         levels=c(0,1), \n         labels = c(\"No\", \"Yes\"))\ndf_ha_use$ha_number_of_ha <- \n  factor(df_ha_use$ha_number_of_ha, \n         levels=c(1:3), \n         labels = c(\"Both ears\",\"Right ear\",\"Left ear\"))\ndf_ha_use$ha_dispencer <- \n  factor(df_ha_use$ha_dispencer, \n         levels=c(1:4), \n         labels = c(\"Høreklinikken, OUH\",\"Audiologisk afdeling, Ålborg\",\"Anden offentlig høreklinik\", \"Privat leverandør\"))\n\n#ssq + ioi\ndf_ssq_ioi <- rbind(read.csv(paste(datafolder,\"SSQ12_IOI-HA_visit_2.csv\",sep=\"/\")))\ndf_ssq_ioi[,16:22] <- lapply(df_ssq_ioi[,16:22], factor, \n                       levels=c(0,1,2,3,4), \n                       ordered = TRUE)\ndf_ssq_ioi$ssq12_dk_complete <- factor(df_ssq_ioi$ssq12_dk_complete, levels = c(0,1,2), labels = fa_fin)\ndf_ssq_ioi$ioiha_dk_complete <- factor(df_ssq_ioi$ioiha_dk_complete, levels = c(0,1,2), labels = fa_fin)\n\ncolnames(df_ssq_ioi)[colnames(df_ssq_ioi)==\"ssq_sppech_q1\"] <- \"ssq_speech_q1\"\n\ndf_ssq.wider <- rbind(read.csv(paste(datafolder,\"SSQ-baseline.csv\",sep=\"/\")), read.csv(paste(datafolder,\"SSQ-follow-up.csv\",sep=\"/\")))\ndf_ssq <- select(df_ssq_ioi, record_id, redcap_event_name, ssq_speech_q1, ssq_speech_q4, ssq_speech_q10, ssq_speech_q11, ssq_speech_q12, ssq_space_q6, ssq_space_q9, ssq_space_q13, ssq_sound_q2, ssq_sound_q7, ssq_sound_q9, ssq_sound_q14, ssq12_dk_complete)\n\ndf_ssq_base <- filter(df_ssq.wider, redcap_event_name == \"baseline_arm_1\")\ndf_ssq_follow <- filter(df_ssq.wider, redcap_event_name == \"besoeg2_arm_1\")\n\nssq_diff <- df_ssq %>% \n  filter(ssq12_dk_complete == \"Complete\") %>% \n  filter(record_id %in% df_ssq_follow$record_id) %>% group_by(record_id) %>% \n  summarise_each(funs(if(is.numeric(.)) last(.)-first(.) else first(.)))\n\ndf_use_group <- df_ha_use %>% filter(!is.na(ha_usetime_hours_per_day)) %>% mutate(use_group = cut(x=ha_usetime_hours_per_day, breaks=c(0,1,4,8,24), labels = c(\"Very low(<1)\",\"Low(1-4)\", \"Medium(4-8)\", \"High(>8)\"), include.lowest = TRUE))\n\ndf_ssq_diff_group <- merge(ssq_diff, df_use_group[,c(1, 11)], by='record_id')\ndf_ssq_diff_group <- filter(df_ssq_diff_group, !is.na(use_group))\ndf_ioi <- select(df_ssq_ioi, record_id, redcap_event_name, ioi_ha_1, ioi_ha_2, ioi_ha_3, ioi_ha_4, ioi_ha_5, ioi_ha_6, ioi_ha_7, ioiha_dk_complete)\n\ndf_ssq_diff_group <- merge(df_ssq_diff_group, df_ioi, by=c('record_id', 'redcap_event_name'))\n\n\ndf_ssq$ssq_speech_mean <- rowMeans(df_ssq[,grepl(\"ssq_speech\", colnames(df_ssq))], na.rm = TRUE)\ndf_ssq$ssq_space_mean <- rowMeans(df_ssq[,grepl(\"ssq_space\", colnames(df_ssq))], na.rm = TRUE)\ndf_ssq$ssq_sound_mean <- rowMeans(df_ssq[,grepl(\"ssq_sound\", colnames(df_ssq))], na.rm = TRUE)\n\n#ioi\n#df_benefit_ioi <- read.csv(paste(datafolder, \"Low-benefit3rd.csv\", sep = \"/\"), colClasses = c(\"factor\", \"factor\", \"numeric\",  rep('factor', 9), rep(\"numeric\", 4))) #5/19\ndf_ioi <- select(df_ssq_ioi, record_id, redcap_event_name, ioi_ha_1, ioi_ha_2, ioi_ha_3, ioi_ha_4, ioi_ha_5, ioi_ha_6, ioi_ha_7, ioiha_dk_complete)\ndf_ioi_base <- filter(df_ioi, redcap_event_name == \"baseline_arm_1\")\ndf_ioi_follow <- filter(df_ioi, redcap_event_name == \"besoeg2_arm_1\")\n\ndf_ioi_base <- rbind(read.csv(paste(datafolder,\"SSQ12_IOI-HA_baseline.csv\",sep=\"/\")))\ndf_ioi_base[,16:22] <- lapply(df_ioi_base[,16:22], factor, \n                             levels=c(0,1,2,3,4), \n                             ordered = TRUE)\ndf_ioi_base <- select(df_ioi_base, record_id, redcap_event_name, ioi_ha_1, ioi_ha_2, ioi_ha_3, ioi_ha_4, ioi_ha_5, ioi_ha_6, ioi_ha_7, ioiha_dk_complete)\n\n#df_ioi[,3:9] <- lapply(df_ioi[,3:9], factor, \n#                       levels=c(0,1,2,3,4), \n#                       ordered = TRUE)\n\n#time\ndf_time_between <- read.csv(paste(datafolder,\"Tid-mellem.csv\", sep=\"/\"))#1/19\ndf_time_between$visit_date_ha_delivery <- as.Date(df_time_between$visit_date_ha_delivery, format = \"%Y-%m-%d\")\ndf_time_between$visit_date_2 <- as.Date(df_time_between$visit_date_2, format = \"%Y-%m-%d\")\n\ndf_time_between <- mutate(df_time_between, interval = visit_date_2 - visit_date_ha_delivery)\n\n#Tinnitus (THI) (ikke testet)\ndf_thi <- rbind(read.csv(paste(datafolder,\"THI-baseline.csv\",sep=\"/\")), \n                read.csv(paste(datafolder,\"THI-follow-up.csv\",sep=\"/\")))\ndf_thi$tinnitus <- factor(df_thi$tinnitus,\n                                   levels = c(0,1,999), \n                                   labels = c(\"No\", \"Yes\", \"Don't know\"))\n\na.fun <- function(i){\n  if(is.na(i)) return(NA)\n  if(i==0) return(0)\n  if(i==1) return(4)\n  if(i==2) return(2)\n  return(NA)\n}\n\ndf_thi$Score <- NA\nfor(row in 1:nrow(df_thi)){\n  if(df_thi$tinnitus_complete[row] == 0) {\n    df_thi[row,30] <- NA\n  } else {\n    num <- 0\n    for(col in 4:28){\n      if(!is.na(a.fun(df_thi[row,col])))\n      {\n        num <- num + a.fun(df_thi[row,col])\n      }\n    }\n    df_thi$Score[row] <- num\n  }\n}\n                        \ndf_thi[,4:28] <- lapply(df_thi[,4:28], factor, \n                                 levels=c(0,1,2), \n                                 labels = c(\"No\", \"Yes\", \"Occasionally\"))\n\ndf_thi$tinnitus_complete <- factor(df_thi$tinnitus_complete,\n                                            levels = c(0,1,2), \n                                            labels = fa_fin)\n\ndf_thi <- mutate(df_thi, THI_grade=cut(Score, \n                                      breaks=c(0,16,36,56,76,100),\n                                      labels=c(\"Very mild\", \"Mild\", \"Moderate\", \"Severe\", \"Catastrofic\"),\n                                      include.lowest = TRUE))\n\ndf_thi_baseline <- filter(df_thi, redcap_event_name == \"baseline_arm_1\")\ndf_thi_followup <- filter(df_thi, redcap_event_name == \"besoeg2_arm_1\")\n\n\n#tinnitus noise\ndf_tinnitus <- read.csv(paste(datafolder, \"Tinnitus.csv\", sep=\"/\")) #7/19\ndf_tinnitus$sex <- factor(df_tinnitus$sex,\n                          levels = c(1,2), \n                          labels = fa_sex)\n\ndf_tinnitus[,5:8] <- lapply(df_tinnitus[,5:8], factor, \n                            levels = c(0,1,999), \n                            labels = c(\"No\", \"Yes\", \"Don't know\"))\ndf_tinnitus$noise_industry_1 <- factor(df_tinnitus$noise_industry_1,\n                                       levels = c(1,2,3,4,5,6,7,8,9,10,11,12,13), \n                                       labels = c(\"sund/plej/omso\", \"unde/fors/pæda\", \"rest/køkk/reng\", \"admi/kont\", \"hånd/kons/anlæg\", \"mech/mont/oper\", \"tran/lage/reno\", \"hand/serv/deta\", \"mili\", \"poli/redn\", \"føde/indu\", \"land/fisk/skov/dyr\", \"andet\"))\n\ndf_tinnitus$noise_type_1 <- factor(df_tinnitus$noise_type_1,\n                                   levels = c(1,2,3,4), \n                                   labels = c(\"Impulse\", \"Continous\", \"Tonal\", \"Jævnt variende i intensitet\"))\n\ndf_tinnitus$noise_work_intensity_1 <- factor(df_tinnitus$noise_work_intensity_1,\n                                             levels = c(1,2,3,4), \n                                             labels = c(\"Extremely loud\", \"Very loud\", \"Loud\", \"Annoying\"),\n                                             ordered = TRUE)\n\ndf_tinnitus$noise_work_duration_1 <- factor(df_tinnitus$noise_work_duration_1,\n                                            levels = c(1,2,3), \n                                            labels = c(\"All day\", \"Approx. half day\", \"Less than half day\"),\n                                            ordered = TRUE)\n\ndf_tinnitus$alcohol_consumption <- factor(df_tinnitus$alcohol_consumption,\n                                          levels = c(1,2,3,4,5,6), \n                                          labels = c(\"None\", \"Rarely\", \"1-2/week\", \"3-7/week\", \"8-12/week\", \"More\"),\n                                          ordered = TRUE)\n\ndf_tinnitus$smoking_number_of_cigarets <- factor(df_tinnitus$alcohol_consumption,\n                                                 levels = c(1,2,3,4,5,6), \n                                                 labels = c(\"None\", \"Rarely\", \"1-2/day\", \"2-10/day\", \"10-20/day\", \"More\"),\n                                                 ordered = TRUE)\n\n# drawer user\n\nsort_class_severity <- df_audiogram[,4:10] %>% melt() %>% group_by(Class, variable) %>% dplyr::summarise(value = mean(value)) %>% group_by(Class) %>% summarise(value=mean(value*value))\n\nsorted_classes <- sort_class_severity[order(sort_class_severity$value),]$Class\n\ndf_audiogram$Class <- factor(df_audiogram$Class, levels = sorted_classes, ordered = TRUE)\n\ndf_user_worstear <- df_audiogram %>% group_by(record_id) %>% summarise(class=max(Class))\n\nids.t1 <- df_user_worstear %>% merge(df_audiogram, by = \"record_id\") %>% merge(df_ha_use, by=(\"record_id\")) %>% filter(ha_usetime_hours_per_day < 3)\nids.t3 <- df_user_worstear %>% merge(df_audiogram, by = \"record_id\") %>% merge(df_ha_use, by=(\"record_id\")) %>% filter(class > \"S1\" & ha_usetime_hours_per_day < 3)\n\nt3.data.ssq <- df_ssq %>% mutate(IsT1DrawerUser=factor(record_id %in% ids.t1$record_id),\n                                 IsT3DrawerUser=factor(record_id %in% ids.t3$record_id),\n                                 IsDrawerUser=factor(ifelse(record_id %in% ids.t3$record_id, 3, ifelse(record_id %in% ids.t1$record_id, 2, 1)), \n                                                     levels = 1:3, \n                                                     labels = c(\"No\", \"Yes\", \"Yes/t3\"), ordered = TRUE))\nt3.data.thi <- df_thi %>% mutate(IsT1DrawerUser=factor(record_id %in% ids.t1$record_id),\n                                 IsT3DrawerUser=factor(record_id %in% ids.t3$record_id),\n                                 IsDrawerUser=factor(ifelse(record_id %in% ids.t3$record_id, 3, ifelse(record_id %in% ids.t1$record_id, 2, 1)), \n                                                     levels = 1:3, \n                                                     labels = c(\"No\", \"Yes\", \"Yes/t3\"), ordered = TRUE))\nt3.data.15d <- df_15d %>% mutate(IsT1DrawerUser=factor(record_id %in% ids.t1$record_id),\n                                 IsT3DrawerUser=factor(record_id %in% ids.t3$record_id),\n                                 IsDrawerUser=factor(ifelse(record_id %in% ids.t3$record_id, 3, ifelse(record_id %in% ids.t1$record_id, 2, 1)), \n                                                     levels = 1:3, \n                                                     labels = c(\"No\", \"Yes\", \"Yes/t3\"), ordered = TRUE))\n\n\n\n#mean audiogram \n\ndf_audiogram <- read.csv(paste(datafolder,'MeanAudiogramClass.csv', sep='/'))\n\ndf_audiogram <- df_audiogram[,-c(1)]\n\nnames(df_audiogram) <- c('record_id','AudClass')\n\n\n#Carlson Comorbidity Index\ndf_CCI <- read.csv(paste(datafolder, 'CCI-skema.csv', sep='/'))\n\ndf_CCI <- df_CCI[, -c(2)]\n\n\n\n\n\n\n",
    "created" : 1570540467530.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1408635793",
    "id" : "D0559B58",
    "lastKnownWriteTime" : 1570544952,
    "last_content_update" : 1570544952503,
    "path" : "~/BEAR/MsC code/bear-msc/Age&Hearing/setup.R",
    "project_path" : "setup.R",
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}